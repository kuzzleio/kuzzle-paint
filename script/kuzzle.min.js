!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){function r(){var e=this,t=Date.now(),n=-1;e.queueTTL>0&&(e.offlineQueue.forEach(function(r,i){r.ts<t-e.queueTTL&&(n=i)}),-1!==n&&e.offlineQueue.splice(0,n+1).forEach(function(t){e.emitEvent("offlineQueuePop",t.query)})),e.queueMaxSize>0&&e.offlineQueue.length>e.queueMaxSize&&e.offlineQueue.splice(0,e.offlineQueue.length-e.queueMaxSize).forEach(function(t){e.emitEvent("offlineQueuePop",t.query)})}function i(e){var t=Date.now();Object.keys(e).forEach(function(n){e[n]<t-1e4&&delete e[n]}),setTimeout(function(){i(e)},1e3)}function o(e,t){var n=this;(void 0!==n.jwtToken||t)&&n.network.once(e.requestId,function(r){var i=null;"logout"!==e.action&&r.error&&"Token expired"===r.error.message&&(n.jwtToken=void 0,n.emitEvent("jwtTokenExpired",e,t)),r.error&&(i=new Error(r.error.message),Object.assign(i,r.error),i.status=r.status,n.emitEvent("queryError",i,e,t)),t&&t(i,r)}),this.network.send(e),n.requestHistory[e.requestId]=Date.now()}function s(){var e,t=this,n={},r=function(){t.offlineQueue.length>0?(o.call(t,t.offlineQueue[0].query,t.offlineQueue[0].cb),t.emitEvent("offlineQueuePop",t.offlineQueue.shift()),setTimeout(function(){r()},Math.max(0,t.replayInterval))):t.queuing=!1};if(t.offlineQueueLoader){if("function"!=typeof t.offlineQueueLoader)throw new Error("Invalid value for offlineQueueLoader property. Expected: function. Got: "+typeof t.offlineQueueLoader);if(e=t.offlineQueueLoader(),!Array.isArray(e))throw new Error("Invalid value returned by the offlineQueueLoader function. Expected: array. Got: "+typeof e);t.offlineQueue=e.concat(t.offlineQueue).filter(function(e){if(!e.query||void 0===e.query.requestId||!e.query.action||!e.query.controller)throw new Error("Invalid offline queue request. One or more missing properties: requestId, action, controller.");return n.hasOwnProperty(e.query.requestId)?!1:n[e.query.requestId]=!0})}r()}function u(){var e=this;Object.keys(e.subscriptions).forEach(function(t){Object.keys(e.subscriptions[t]).forEach(function(n){var r=e.subscriptions[t][n];r.renew(r.callback)})})}function l(){var e=this;Object.keys(e.subscriptions).forEach(function(t){Object.keys(e.subscriptions[t]).forEach(function(n){var r=e.subscriptions[t][n];r.unsubscribe()})})}var a=n(4),c=n(5),f=n(15),d=n(8),h=n(3),p=n(11);e.exports=Kuzzle=function(e,t,n){var r=this;if(!(this instanceof Kuzzle))return new Kuzzle(e,t,n);if(n||"function"!=typeof t||(n=t,t=null),!e||""===e)throw new Error("host argument missing");return Object.defineProperties(this,{collections:{value:{},writable:!0},connectCB:{value:n},eventListeners:{value:{connected:{lastEmitted:null,listeners:[]},error:{lastEmitted:null,listeners:[]},disconnected:{lastEmitted:null,listeners:[]},reconnected:{lastEmitted:null,listeners:[]},jwtTokenExpired:{lastEmitted:null,listeners:[]},loginAttempt:{lastEmitted:null,listeners:[]},offlineQueuePush:{listeners:[]},offlineQueuePop:{listeners:[]},queryError:{listeners:[]}}},eventTimeout:{value:200},queuing:{value:!1,writable:!0},requestHistory:{value:{},writable:!0},state:{value:"initializing",writable:!0},subscriptions:{value:{pending:{}},writable:!0},autoReconnect:{value:t&&"boolean"==typeof t.autoReconnect?t.autoReconnect:!0,enumerable:!0},defaultIndex:{value:t&&"string"==typeof t.defaultIndex?t.defaultIndex:void 0,writable:!0,enumerable:!0},reconnectionDelay:{value:t&&"number"==typeof t.reconnectionDelay?t.reconnectionDelay:1e3,enumerable:!0},host:{value:e,writable:!0,enumerable:!0},wsPort:{value:t&&"number"==typeof t.wsPort?t.wsPort:7513,enumerable:!0,writable:!0},ioPort:{value:t&&"number"==typeof t.ioPort?t.ioPort:7512,enumerable:!0,writable:!0},sslConnection:{value:t&&"boolean"==typeof t.sslConnection?t.sslConnection:!1,enumerable:!0},autoQueue:{value:!1,enumerable:!0,writable:!0},autoReplay:{value:!1,enumerable:!0,writable:!0},autoResubscribe:{value:!0,enumerable:!0,writable:!0},headers:{value:{},enumerable:!0,writable:!0},metadata:{value:{},enumerable:!0,writable:!0},offlineQueue:{value:[],enumerable:!0,writable:!0},queueFilter:{value:null,enumerable:!0,writable:!0},queueMaxSize:{value:500,enumerable:!0,writable:!0},queueTTL:{value:12e4,enumerable:!0,writable:!0},replayInterval:{value:10,enumerable:!0,writable:!0},jwtToken:{value:void 0,enumerable:!0,writable:!0},offlineQueueLoader:{value:null,enumerable:!0,writable:!0}}),t&&(Object.keys(t).forEach(function(e){r.hasOwnProperty(e)&&Object.getOwnPropertyDescriptor(r,e).writable&&(r[e]=t[e])}),"auto"===t.offlineMode&&this.autoReconnect&&(this.autoQueue=this.autoReplay=this.autoResubscribe=!0)),Object.defineProperty(this,"isValid",{value:function(){if("disconnected"===r.state)throw new Error("This Kuzzle object has been invalidated. Did you try to access it after a disconnect call?")}}),Object.defineProperty(this,"addHeaders",{value:function(e,t){return Object.keys(t).forEach(function(n){e[n]||(e[n]=t[n])}),e}}),Object.defineProperty(this,"callbackRequired",{value:function(e,t){if(!t||"function"!=typeof t)throw new Error(e+": a callback argument is required for read queries")}}),Object.defineProperty(this,"security",{value:new f(this),enumerable:!0}),Object.defineProperty(this,"emitEvent",{value:function(e){var t=Date.now(),n=Array.prototype.slice.call(arguments,1),r=this.eventListeners[e];return r.lastEmitted&&r.lastEmitted>=t-this.eventTimeout?!1:(r.listeners.forEach(function(e){process.nextTick(function(){e.fn.apply(void 0,n)})}),void(void 0!==r.lastEmitted&&(r.lastEmitted=t)))}}),Object.defineProperty(this,"memoryStorage",{value:new d(this),enumerable:!0}),t&&t.connect&&"auto"!==t.connect?this.state="ready":this.connect(),i(this.requestHistory),this.bluebird?this.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["getAllStatistics","getServerInfo","getStatistics","listCollections","listIndexes","login","logout","now","query","checkToken","whoAmI","updateSelf","getMyRights","refreshIndex","getAutoRefresh","setAutoRefresh"];return r&&-1!==i.indexOf(e)}}):void 0},Kuzzle.prototype.connect=function(){var e=this;return e.network&&e.disconnect(),e.network=p(e.host,e.wsPort,e.ioPort,e.sslConnection),-1===["initializing","ready","disconnected","error","offline"].indexOf(this.state)?(e.connectCB&&e.connectCB(null,e),e):(e.state="connecting",e.network.connect(e.autoReconnect,e.reconnectionDelay),e.network.onConnect(function(){e.state="connected",u.call(e),s.call(e),e.emitEvent("connected"),e.connectCB&&e.connectCB(null,e)}),e.network.onConnectError(function(t){var n=new Error('Unable to connect to kuzzle proxy server at "'+e.host+'"');n.internal=t,e.state="error",e.emitEvent("error",n),e.connectCB&&e.connectCB(n)}),e.network.onDisconnect(function(){e.state="offline",e.autoReconnect||e.disconnect(),e.autoQueue&&(e.queuing=!0),e.emitEvent("disconnected")}),e.network.onReconnect(function(){var t=function(){e.autoResubscribe&&u.call(e),e.autoReplay&&(r.call(e),s.call(e)),e.emitEvent("reconnected")};e.state="connected",e.jwtToken?e.checkToken(e.jwtToken,function(n,r){(n||!r.valid)&&(e.jwtToken=void 0,e.emitEvent("jwtTokenExpired")),t()}):t()}),this)},Kuzzle.prototype.setJwtToken=function(e){if("string"==typeof e)this.jwtToken=e;else{if("object"!=typeof e)return this.emitEvent("loginAttempt",{success:!1,error:"Invalid token argument: "+e}),this;if(!e.result||!e.result.jwt||"string"!=typeof e.result.jwt)return this.emitEvent("loginAttempt",{success:!1,error:"Cannot find a valid JWT token in the following object: "+JSON.stringify(e)}),this;this.jwtToken=e.result.jwt}return u.call(this),this.emitEvent("loginAttempt",{success:!0}),this},Kuzzle.prototype.unsetJwtToken=function(){return this.jwtToken=void 0,l.call(this),this},Kuzzle.prototype.getJwtToken=function(){return this.jwtToken},Kuzzle.prototype.login=function(e){var t,n=this,r={strategy:e},i=null;arguments[1]&&("object"==typeof arguments[1]?t=arguments[1]:"number"==typeof arguments[1]||"string"==typeof arguments[1]?r.expiresIn=arguments[1]:"function"==typeof arguments[1]&&(i=arguments[1])),arguments[2]&&("number"==typeof arguments[2]||"string"==typeof arguments[2]?r.expiresIn=arguments[2]:"function"==typeof arguments[2]&&(i=arguments[2])),arguments[3]&&"function"==typeof arguments[3]&&(i=arguments[3]),"object"==typeof t&&Object.keys(t).forEach(function(e){r[e]=t[e]}),this.query({controller:"auth",action:"login"},{body:r},{queuable:!1},function(e,t){e?(i&&i(e),n.emitEvent("loginAttempt",{success:!1,error:e.message})):(t.result.jwt&&n.setJwtToken(t.result.jwt),i&&i(null,t.result))})},Kuzzle.prototype.logout=function(e){var t=this,n={action:"logout",controller:"auth",requestId:a.v4(),body:{}};return this.query({controller:"auth",action:"logout"},n,{queuable:!1},"function"!=typeof e?null:function(n){null===n?(t.unsetJwtToken(),e(null,t)):e(n)}),t},Kuzzle.prototype.checkToken=function(e,t){var n={body:{token:e}};this.callbackRequired("Kuzzle.checkToken",t),this.query({controller:"auth",action:"checkToken"},n,{queuable:!1},function(e,n){return e?t(e):void t(null,n.result)})},Kuzzle.prototype.whoAmI=function(e){var t=this;t.callbackRequired("Kuzzle.whoAmI",e),t.query({controller:"auth",action:"getCurrentUser"},{},{},function(n,r){return n?e(n):void e(null,new h(t.security,r.result._id,r.result._source))})},Kuzzle.prototype.getMyRights=function(e,t){var n=this;t||"function"!=typeof e||(t=e,e=null),n.callbackRequired("Kuzzle.getMyRights",t),n.query({controller:"auth",action:"getMyRights"},{},e,function(e,n){return e?t(e):void t(null,n.result.hits)})},Kuzzle.prototype.updateSelf=function(e,t,n){var r=this,i={},o={controller:"auth",action:"updateSelf"};return n||"function"!=typeof t||(n=t,t=null),i.body=e,r.query(o,i,t,n&&function(e,t){n(e,e?void 0:t.result)}),this},Kuzzle.prototype.addListener=function(e,t){var n,r=Object.keys(this.eventListeners),i=typeof t;if(this.isValid(),-1===r.indexOf(e))throw new Error("["+e+"] is not a known event. Known events: "+r.toString());if("function"!==i)throw new Error("Invalid listener type: expected a function, got a "+i);return n=a.v4(),this.eventListeners[e].listeners.push({id:n,fn:t}),n},Kuzzle.prototype.getAllStatistics=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.getAllStatistics",t),this.query({controller:"admin",action:"getAllStats"},{},e,function(e,n){return e?t(e):void t(null,n.result.hits)})},Kuzzle.prototype.getStatistics=function(e,t,n){var r,i;n||(1===arguments.length?(n=arguments[0],t=null,e=null):(n=arguments[1],"object"==typeof arguments[0]?(t=arguments[0],e=null):(e=arguments[0],t=null))),r=function(t,r){return t?n(t):void n(null,e?r.result.hits:[r.result])},this.callbackRequired("Kuzzle.getStatistics",n),i=e?{body:{startTime:e}}:{},this.query({controller:"admin",action:e?"getStats":"getLastStats"},i,t,r)},Kuzzle.prototype.dataCollectionFactory=function(e,t){if(this.isValid(),!t){if(!this.defaultIndex)throw new Error("Unable to create a new data collection object: no index specified");t=this.defaultIndex}if("string"!=typeof t||"string"!=typeof e)throw new Error("Invalid index or collection argument: string expected");return this.collections[t]||(this.collections[t]={}),this.collections[t][e]||(this.collections[t][e]=new c(this,e,t)),this.collections[t][e]},Kuzzle.prototype.flushQueue=function(){return this.offlineQueue=[],this},Kuzzle.prototype.listCollections=function(){var e,t,n,r,i="all",o=Array.prototype.slice.call(arguments);if(o.forEach(function(r){switch(typeof r){case"string":e=r;break;case"object":t=r;break;case"function":n=r}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.listCollections: index required");e=this.defaultIndex}this.callbackRequired("Kuzzle.listCollections",n),t&&t.type&&(i=t.type),r={body:{type:i}},t&&t.from&&(r.body.from=t.from),t&&t.size&&(r.body.size=t.size),this.query({index:e,controller:"read",action:"listCollections"},r,t,function(e,t){return e?n(e):void n(null,t.result.collections)})},Kuzzle.prototype.listIndexes=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.listIndexes",t),this.query({controller:"read",action:"listIndexes"},{},e,function(e,n){t(e,e?void 0:n.result.indexes)})},Kuzzle.prototype.disconnect=function(){var e;this.state="disconnected",this.network.close(),this.network=null;for(e in this.collections)this.collections.hasOwnProperty(e)&&delete this.collections[e]},Kuzzle.prototype.getServerInfo=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.getServerInfo",t),this.query({controller:"read",action:"serverInfo"},{},e,function(e,n){return e?t(e):void t(null,n.result.serverInfo)})},Kuzzle.prototype.refreshIndex=function(){var e,t,n;if(Array.prototype.slice.call(arguments).forEach(function(r){switch(typeof r){case"string":e=r;break;case"object":t=r;break;case"function":n=r}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.refreshIndex: index required");e=this.defaultIndex}return this.query({index:e,controller:"admin",action:"refreshIndex"},{},t,n),this},Kuzzle.prototype.getAutoRefresh=function(){var e,t,n;if(Array.prototype.slice.call(arguments).forEach(function(r){switch(typeof r){case"string":e=r;break;case"object":t=r;break;case"function":n=r}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.getAutoRefresh: index required");e=this.defaultIndex}this.callbackRequired("Kuzzle.getAutoRefresh",n),this.query({index:e,controller:"admin",action:"getAutoRefresh"},{},t,n)},Kuzzle.prototype.setAutoRefresh=function(){var e,t,n,r;if(Array.prototype.slice.call(arguments).forEach(function(i){switch(typeof i){case"string":e=i;break;case"boolean":t=i;break;case"object":n=i;break;case"function":r=i}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.setAutoRefresh: index required");e=this.defaultIndex}if(void 0===t)throw new Error("Kuzzle.setAutoRefresh: autoRefresh value is required");return this.query({index:e,controller:"admin",action:"setAutoRefresh"},{body:{autoRefresh:t}},n,r),this},Kuzzle.prototype.now=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.now",t),this.query({controller:"read",action:"now"},{},e,function(e,n){t(e,n&&n.result.now)})},Kuzzle.prototype.query=function(e,t,n,i){var s,u={action:e.action,controller:e.controller,metadata:this.metadata},l=this;if(this.isValid(),i||"function"!=typeof n||(i=n,n=null),n&&(n.metadata&&Object.keys(n.metadata).forEach(function(e){u.metadata[e]=n.metadata[e]}),n.queuable===!1&&"offline"===l.state))return l;if(!t||"object"!=typeof t||Array.isArray(t))throw new Error("Invalid query parameter: "+t);t.metadata&&Object.keys(t.metadata).forEach(function(e){u.metadata[e]=t.metadata[e]});for(s in t)"metadata"!==s&&t.hasOwnProperty(s)&&(u[s]=t[s]);return u=l.addHeaders(u,this.headers),void 0===l.jwtToken||"auth"===u.controller&&"checkToken"===u.action||(u.headers=u.headers||{},u.headers.authorization="Bearer "+l.jwtToken),e.collection&&(u.collection=e.collection),e.index&&(u.index=e.index),u.requestId||(u.requestId=a.v4()),"connected"===l.state||n&&n.queuable===!1?"connected"===l.state?o.call(this,u,i):i&&i(new Error("Unable to execute request: not connected to a Kuzzle server.\nDiscarded request: "+JSON.stringify(u))):(l.queuing||-1!==["initializing","connecting"].indexOf(l.state))&&(r.call(this,u,i),(!l.queueFilter||l.queueFilter(u))&&(l.offlineQueue.push({ts:Date.now(),query:u,cb:i}),l.emitEvent("offlineQueuePush",{query:u,cb:i}))),l},Kuzzle.prototype.removeAllListeners=function(e){var t=Object.keys(this.eventListeners),n=this;if(e){if(-1===t.indexOf(e))throw new Error("["+e+"] is not a known event. Known events: "+t.toString());this.eventListeners[e].listeners=[]}else t.forEach(function(e){n.eventListeners[e].listeners=[]});return this},Kuzzle.prototype.removeListener=function(e,t){var n=Object.keys(this.eventListeners),r=this;if(-1===n.indexOf(e))throw new Error("["+e+"] is not a known event. Known events: "+n.toString());return this.eventListeners[e].listeners.forEach(function(n,i){n.id===t&&r.eventListeners[e].listeners.splice(i,1)}),this},Kuzzle.prototype.replayQueue=function(){return"offline"===this.state||this.autoReplay||(r.call(this),s.call(this)),this},Kuzzle.prototype.setDefaultIndex=function(e){if("string"!=typeof e)throw new Error("Invalid default index: ["+e+"] (an index name is expected)");if(0===e.length)throw new Error("Cannot set an empty index as the default index");return this.defaultIndex=e,this},Kuzzle.prototype.setHeaders=function(e,t){var n=this;if("object"!=typeof e||Array.isArray(e))throw new Error("Expected a content object, received a "+typeof e);return t?n.headers=e:Object.keys(e).forEach(function(t){n.headers[t]=e[t]}),n},Kuzzle.prototype.startQueuing=function(){return"offline"!==this.state||this.autoQueue||(this.queuing=!0),this},Kuzzle.prototype.stopQueuing=function(){return"offline"!==this.state||this.autoQueue||(this.queuing=!1),this}},function(e,t){function n(e,t,n){if(!t)throw new Error("A security document must have an id");return Object.defineProperties(this,{kuzzle:{value:e.kuzzle},kuzzleSecurity:{value:e},id:{value:t,enumerable:!0},content:{value:{},writable:!0,enumerable:!0}}),n&&this.setContent(n,!0),e.kuzzle.bluebird?e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["delete","update"];return r&&-1!==i.indexOf(e)}}):void 0}n.prototype.setContent=function(e){return this.content=e,this},n.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e},n.prototype["delete"]=function(e,t){var n=this;e&&void 0===t&&"function"==typeof e&&(t=e,e=null),n.kuzzle.query(this.kuzzleSecurity.buildQueryArgs(this.deleteActionName),{_id:this.id},e,function(e,n){return e?t?t(e):!1:void(t&&t(null,n.result._id))})},n.prototype.update=function(e,t,n){var r={},i=this;if("object"!=typeof e)throw new Error('Parameter "content" must be a object');return t&&void 0===n&&"function"==typeof t&&(n=t,t=null),r._id=i.id,r.body=e,i.kuzzle.query(this.kuzzleSecurity.buildQueryArgs(this.updateActionName),r,t,function(e,t){return e?n?n(e):!1:(i.setContent(t.result._source),void(n&&n(null,i)))}),this},e.exports=n},function(e,t,n){function r(e,t,r){var s=this;this.WebSocket="undefined"!=typeof WebSocket?WebSocket:n(!function(){var e=new Error('Cannot find module "ws"');throw e.code="MODULE_NOT_FOUND",e}()),this.host=e,this.port=t,this.ssl=r,this.client=null,this.wasConnected=!1,this.retrying=!1,this.lasturl=null,this.listeners={error:[],connect:[],disconnect:[],reconnect:[]},this.connect=function(e,t){var n=(this.ssl?"wss://":"ws://")+this.host+":"+this.port,r="undefined"!=typeof window?void 0:{perMessageDeflate:!1};n!==this.lasturl&&(s.wasConnected=!1,this.lasturl=n),this.client=new this.WebSocket(n,r),this.client.onopen=function(){s.wasConnected?i(s.listeners,"reconnect"):i(s.listeners,"connect"),s.wasConnected=!0},this.client.onclose=function(n,r){1e3===n?i(s.listeners,"disconnect"):o.call(s,e,t,r)},this.client.onerror=function(n){o.call(s,e,t,n)},this.client.onmessage=function(e){var t=JSON.parse(e.data||e);t.room&&s.listeners[t.room]&&i(s.listeners,t.room,t)}},this.onConnect=function(e){this.listeners.connect.push({fn:e,keep:!0})},this.onConnectError=function(e){this.listeners.error.push({fn:e,keep:!0})},this.onDisconnect=function(e){this.listeners.disconnect.push({fn:e,keep:!0})},this.onReconnect=function(e){this.listeners.reconnect.push({fn:e,keep:!0})},this.once=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push({fn:t,keep:!1})},this.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push({fn:t,keep:!0})},this.off=function(e,t){var n;this.listeners[e]&&(n=this.listeners[e].findIndex(function(e){return e.fn===t}),-1!==n&&(1===this.listeners[e].length&&-1===["error","connect","disconnect","reconnect"].indexOf(e)?delete this.listeners[e]:this.listeners[e].splice(n,1)))},this.send=function(e){this.client&&this.client.readyState===this.client.OPEN&&this.client.send(JSON.stringify(e))},this.close=function(){this.listeners={error:[],connect:[],disconnect:[],reconnect:[]},this.wasConnected=!1,this.client.close(),this.client=null}}function i(e,t,n){var r,i=e[t].length;for(r=0;i>r;++r)e[t][r].fn(n),e[t][r].keep||(e[t].length>1?(e[t].splice(r,1),--r,--i):delete e[t])}function o(e,t,n){var r=this;e&&!r.retrying&&(r.retrying=!0,setTimeout(function(){r.retrying=!1,r.connect(e,t)},t)),i(r.listeners,"error",n)}e.exports=r},function(e,t,n){function r(e,t,n){return i.call(this,e,t,n),Object.defineProperties(this,{deleteActionName:{value:"deleteUser"},updateActionName:{value:"updateUser"}}),e.kuzzle.bluebird?e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["save"];return r&&-1!==i.indexOf(e)}}):void 0}var i=n(1);r.prototype=Object.create(i.prototype,{constructor:{value:r}}),r.prototype.setProfiles=function(e){if(!Array.isArray(e)||"string"!=typeof e[0])throw new Error('Parameter "profileIds" must be an array of strings');return this.content.profileIds=e,this},r.prototype.addProfile=function(e){if("string"!=typeof e)throw new Error('Parameter "profileId" must be a string');return this.content.profileIds||(this.content.profileIds=[]),-1===this.content.profileIds.indexOf(e)&&this.content.profileIds.push(e),this},r.prototype.save=function(e,t){var n=this.serialize(),r=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),r.kuzzle.query(this.kuzzleSecurity.buildQueryArgs("createOrReplaceUser"),n,e,t&&function(e){t(e,e?void 0:r)}),r},r.prototype.serialize=function(){return{_id:this.id,body:this.content}},r.prototype.getProfiles=function(){return this.content.profileIds},e.exports=r},function(e,t){!function(t){"use strict";function n(){var e=t.crypto||t.msCrypto;if(!l&&e&&e.getRandomValues)try{var n=new Uint8Array(16);f=l=function(){return e.getRandomValues(n),n},l()}catch(r){}if(!l){var i=new Array(16);a=l=function(){for(var e,t=0;16>t;t++)0===(3&t)&&(e=4294967296*Math.random()),i[t]=e>>>((3&t)<<3)&255;return i},"undefined"!=typeof console&&console.warn&&console.warn("[SECURITY] node-uuid: crypto not usable, falling back to insecure Math.random()")}}function r(){if("function"==typeof require)try{var e=require("crypto").randomBytes;c=l=e&&function(){return e(16)},l()}catch(t){}}function i(e,t,n){var r=t&&n||0,i=0;for(t=t||[],e.toLowerCase().replace(/[0-9a-f]{2}/g,function(e){16>i&&(t[r+i++]=y[e])});16>i;)t[r+i++]=0;return t}function o(e,t){var n=t||0,r=p;return r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]}function s(e,t,n){var r=t&&n||0,i=t||[];e=e||{};var s=null!=e.clockseq?e.clockseq:m,u=null!=e.msecs?e.msecs:(new Date).getTime(),l=null!=e.nsecs?e.nsecs:g+1,a=u-w+(l-g)/1e4;if(0>a&&null==e.clockseq&&(s=s+1&16383),(0>a||u>w)&&null==e.nsecs&&(l=0),l>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");w=u,g=l,m=s,u+=122192928e5;var c=(1e4*(268435455&u)+l)%4294967296;i[r++]=c>>>24&255,i[r++]=c>>>16&255,i[r++]=c>>>8&255,i[r++]=255&c;var f=u/4294967296*1e4&268435455;i[r++]=f>>>8&255,i[r++]=255&f,i[r++]=f>>>24&15|16,i[r++]=f>>>16&255,i[r++]=s>>>8|128,i[r++]=255&s;for(var d=e.node||v,h=0;6>h;h++)i[r+h]=d[h];return t?t:o(i)}function u(e,t,n){var r=t&&n||0;"string"==typeof e&&(t="binary"===e?new h(16):null,e=null),e=e||{};var i=e.random||(e.rng||l)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var s=0;16>s;s++)t[r+s]=i[s];return t||o(i)}var l,a,c,f,d;t?n():r();for(var h="function"==typeof Buffer?Buffer:Array,p=[],y={},b=0;256>b;b++)p[b]=(b+256).toString(16).substr(1),y[p[b]]=b;var z=l(),v=[1|z[0],z[1],z[2],z[3],z[4],z[5]],m=16383&(z[6]<<8|z[7]),w=0,g=0,k=u;k.v1=s,k.v4=u,k.parse=i,k.unparse=o,k.BufferClass=h,k._rng=l,k._mathRNG=a,k._nodeRNG=c,k._whatwgRNG=f,"undefined"!=typeof e&&e.exports?e.exports=k:"function"==typeof define&&define.amd?define(function(){return k}):(d=t.uuid,k.noConflict=function(){return t.uuid=d,k},t.uuid=k)}("undefined"!=typeof window?window:null)},function(e,t,n){function r(e,t,n){if(!n||!t)throw new Error("The KuzzleDataCollection object constructor needs an index and a collection arguments");return Object.defineProperties(this,{collection:{value:t,enumerable:!0},index:{value:n,enumerable:!0},kuzzle:{value:e,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0}}),Object.defineProperty(this,"buildQueryArgs",{value:function(e,t){return{controller:e,action:t,collection:this.collection,index:this.index}}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["publishMessage","setHeaders","subscribe"];return r&&-1===i.indexOf(e)}}):this}var i=n(7),o=n(6),s=n(9),u=n(10);r.prototype.advancedSearch=function(e,t,n){var r,o=this;n||"function"!=typeof t||(n=t,t=null),o.kuzzle.callbackRequired("KuzzleDataCollection.advancedSearch",n),r=o.kuzzle.addHeaders({body:e},this.headers),o.kuzzle.query(this.buildQueryArgs("read","search"),r,t,function(e,t){var r,s=[];return e?n(e):(t.result.hits.forEach(function(e){var t=new i(o,e._id,e._source);t.version=e._version,s.push(t)}),r={total:t.result.total,documents:s},t.result.aggregations&&(r.aggregations=t.result.aggregations),void n(null,r))})},r.prototype.count=function(e,t,n){var r;n||"function"!=typeof t||(n=t,t=null),this.kuzzle.callbackRequired("KuzzleDataCollection.count",n),r=this.kuzzle.addHeaders({body:e},this.headers),this.kuzzle.query(this.buildQueryArgs("read","count"),r,t,function(e,t){n(e,t&&t.result.count)})},r.prototype.create=function(e,t){var n={};return t||"function"!=typeof e||(t=e,e=null),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("write","createCollection"),n,e,t),this},r.prototype.createDocument=function(e,t,n,r){var o=this,s={},u="create";return e&&"string"!=typeof e&&(r=n,n=t,t=e,e=null),r||"function"!=typeof n||(r=n,n=null),t instanceof i?s=t.serialize():s.body=t,n&&(u=n.updateIfExist?"createOrReplace":"create"),e&&(s._id=e),s=o.kuzzle.addHeaders(s,o.headers),o.kuzzle.query(this.buildQueryArgs("write",u),s,n,r&&function(e,t){var n;return e?r(e):(n=new i(o,t.result._id,t.result._source),n.version=t.result._version,void r(null,n))}),this},r.prototype.deleteDocument=function(e,t,n){var r,i={};return"string"==typeof e?(i._id=e,r="delete"):(i.body=e,r="deleteByQuery"),n||"function"!=typeof t||(n=t,t=null),i=this.kuzzle.addHeaders(i,this.headers),this.kuzzle.query(this.buildQueryArgs("write",r),i,t,n&&function(e,t){e?n(e):n(null,"delete"===r?[t.result._id]:t.result.ids)}),this},r.prototype.fetchDocument=function(e,t,n){var r={_id:e},o=this;n||"function"!=typeof t||(n=t,t=null),o.kuzzle.callbackRequired("KuzzleDataCollection.fetch",n),r=o.kuzzle.addHeaders(r,this.headers),o.kuzzle.query(this.buildQueryArgs("read","get"),r,t,function(e,t){var r;return e?n(e):(r=new i(o,t.result._id,t.result._source),r.version=t.result._version,void n(null,r))})},r.prototype.fetchAllDocuments=function(e,t){var n={};t||"function"!=typeof e||(t=e,e=null),e&&(e.from&&(n.from=e.from),e.size&&(n.size=e.size)),this.kuzzle.callbackRequired("KuzzleDataCollection.fetchAll",t),this.advancedSearch(n,e,t)},r.prototype.getMapping=function(e,t){var n;t||"function"!=typeof e||(t=e,e=null),this.kuzzle.callbackRequired("KuzzleDataCollection.getMapping",t),n=new o(this),n.refresh(e,t)},r.prototype.publishMessage=function(e,t,n){var r={};return e instanceof i?r=e.serialize():r.body=e,r=this.kuzzle.addHeaders(r,this.headers),this.kuzzle.query(this.buildQueryArgs("write","publish"),r,t,n),this},r.prototype.replaceDocument=function(e,t,n,r){var o=this,s={_id:e,body:t};return r||"function"!=typeof n||(r=n,n=null),s=o.kuzzle.addHeaders(s,this.headers),o.kuzzle.query(this.buildQueryArgs("write","createOrReplace"),s,n,r&&function(e,t){var n;return e?r(e):(n=new i(o,t.result._id,t.result._source),n.version=t.result._version,void r(null,n))}),this},r.prototype.subscribe=function(e,t,n){var r,i;return n||"function"!=typeof t||(n=t,t=null),this.kuzzle.callbackRequired("KuzzleDataCollection.subscribe",n),i=new u,r=new s(this,t),r.renew(e,n,i.done.bind(i)),i},r.prototype.truncate=function(e,t){var n={};return t||"function"!=typeof e||(t=e,e=null),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("admin","truncateCollection"),n,e,t),this},r.prototype.updateDocument=function(e,t,n,r){var o={_id:e,body:t},s=this;return r||"function"!=typeof n||(r=n,n=null),o=s.kuzzle.addHeaders(o,this.headers),s.kuzzle.query(this.buildQueryArgs("write","update"),o,n,r&&function(e,t){return e?r(e):void new i(s,t.result._id).refresh(r)}),s},r.prototype.documentFactory=function(e,t){return new i(this,e,t)},r.prototype.roomFactory=function(e){return new s(this,e)},r.prototype.dataMappingFactory=function(e){return new o(this,e)},r.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=r},function(e,t){function n(e,t){return Object.defineProperties(this,{collection:{value:e,enumerable:!0},kuzzle:{value:e.kuzzle,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0},mapping:{value:t||{},enumerable:!0,writable:!0}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["set","setHeaders"];return r&&-1===i.indexOf(e)}}):this}n.prototype.apply=function(e,t){var n=this,r=this.kuzzle.addHeaders({body:{properties:this.mapping}},this.headers);return t||"function"!=typeof e||(t=e,e=null),n.kuzzle.query(this.collection.buildQueryArgs("admin","updateMapping"),r,e,function(r){return r?t&&t(r):void n.refresh(e,t)}),this},n.prototype.refresh=function(e,t){var n=this,r=this.kuzzle.addHeaders({},this.headers);return t||"function"!=typeof e||(t=e,e=null),this.kuzzle.query(this.collection.buildQueryArgs("admin","getMapping"),r,e,function(e,r){return e?t?t(e):!1:r.result[n.collection.index]?r.result[n.collection.index].mappings[n.collection.collection]?(n.mapping=r.result[n.collection.index].mappings[n.collection.collection].properties,void 0===n.mapping&&(n.mapping={}),void(t&&t(null,n))):t&&t(new Error("No mapping found for collection "+n.collection.collection)):t&&t(new Error("No mapping found for index "+n.collection.index))}),this},n.prototype.set=function(e,t){return this.mapping[e]=t,this},n.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=n},function(e,t){function n(e,t,n){return Object.defineProperties(this,{collection:{value:e.collection,enumerable:!0},dataCollection:{value:e,enumerable:!0},kuzzle:{value:e.kuzzle,enumerable:!0},id:{value:void 0,enumerable:!0,writable:!0},content:{value:{},writable:!0,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0},version:{value:void 0,enumerable:!0,writable:!0}}),!n&&t&&"object"==typeof t&&(n=t,t=null),n&&(n._version&&(this.version=n._version,delete n._version),this.setContent(n,!0)),t&&Object.defineProperty(this,"id",{value:t,enumerable:!0}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["delete","refresh","save"];return r&&-1!==i.indexOf(e)}}):this}n.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e._version=this.version,e=this.kuzzle.addHeaders(e,this.headers)},n.prototype.toString=function(){return JSON.stringify(this.serialize())},n.prototype["delete"]=function(e,t){var n=this;if(t||"function"!=typeof e||(t=e,e=null),!n.id)throw new Error("KuzzleDocument.delete: cannot delete a document without a document ID");this.kuzzle.query(this.dataCollection.buildQueryArgs("write","delete"),this.serialize(),e,t&&function(e){
t(e,e?void 0:n.id)})},n.prototype.refresh=function(e,t){var r=this;if(t||"function"!=typeof e||(t=e,e=null),!r.id)throw new Error("KuzzleDocument.refresh: cannot retrieve a document if no ID has been provided");this.kuzzle.callbackRequired("KuzzleDocument.refresh",t),r.kuzzle.query(r.dataCollection.buildQueryArgs("read","get"),{_id:r.id},e,function(e,i){var o;return e?t(e):(o=new n(r.dataCollection,r.id,i.result._source),o.version=i.result._version,void t(null,o))})},n.prototype.save=function(e,t){var n=this.serialize(),r=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),r.kuzzle.query(this.dataCollection.buildQueryArgs("write","createOrReplace"),n,e,function(e,n){return e?t&&t(e):(r.id=n.result._id,r.version=n.result._version,void(t&&t(null,r)))}),r},n.prototype.publish=function(e){var t=this.serialize();return this.kuzzle.query(this.dataCollection.buildQueryArgs("write","publish"),t,e),this},n.prototype.setContent=function(e,t){var n=this;return t?this.content=e:Object.keys(e).forEach(function(t){n.content[t]=e[t]}),this},n.prototype.subscribe=function(e,t){var n;if(e&&!t&&"function"==typeof e&&(t=e,e=null),this.kuzzle.callbackRequired("KuzzleDocument.subscribe",t),!this.id)throw new Error("KuzzleDocument.subscribe: cannot subscribe to a document if no ID has been provided");return n={ids:{values:[this.id]}},this.dataCollection.subscribe(n,e,t)},n.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=n},function(e,t){function n(e){return Object.defineProperties(this,{kuzzle:{value:e,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0}}),this.setHeaders=e.setHeaders.bind(this),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["setHeaders"];return r&&-1===i.indexOf(e)}}):this}!function(){var e=["id","value"],t=["id","keys"],r={append:e,bgrewriteaof:[],bgsave:[],bitcount:["id","start","end"],bitop:["operation","destkey",t],bitpos:["id","bit",{__opts__:["start","end"]}],blpop:[t,"timeout"],brpoplpush:["source","destination"],dbsize:[],decrby:e,del:[t],discard:[],exec:[],exists:[t],expire:["id","seconds"],expireat:["id","timestamp"],flushdb:[],getbit:["id","offset"],getrange:["id","start","end"],hdel:["id",["field","fields"]],hexists:["id","field"],hincrby:["id","field","value"],hmset:["id","values"],hset:["id","field","value"],info:["section"],keys:["pattern"],lastsave:[],lindex:["id","idx"],linsert:["id","position","pivot","value"],lpush:["id",["value","values"]],lrange:["id","start","stop"],lrem:["id","count","value"],lset:["id","idx","value"],ltrim:["id","start","stop"],mset:["values"],multi:[],object:["subcommand","args"],pexpire:["id","milliseconds"],pexpireat:["id","timestamp"],pfadd:["id",["element","elements"]],pfmerge:["destkey",["sourcekey","sourcekeys"]],ping:[],psetex:["id","milliseconds","value"],publish:["channel","message"],randomkey:[],rename:["id","newkey"],renamenx:["id","newkey"],restore:["id","ttl","content"],rpoplpush:["source","destination"],sadd:["id",["member","members"]],save:[],set:["id","value",{__opts__:["ex","px","nx","xx"]}],sdiffstore:["destination",t],setbit:["id","offset","value"],setex:["id","seconds","value"],setrange:["id","offset","value"],sinterstore:["destination",t],sismember:["id","member"],smove:["id","destination","member"],sort:["id",{__opts__:["by","offset","count","get","direction","alpha","store"]}],spop:["id","count"],srem:["id",["member","members"]],sunionstore:["destination",t],unwatch:[],wait:["numslaves","timeout"],zadd:["id",{__opts__:["nx","xx","ch","incr","score","member","members"]}],zcount:["id","min","max"],zincrby:["id","value","member"],zinterstore:["destination",t,{__opts__:["weight","weights","aggregate"]}],zlexcount:["id","min","max"],zrange:["id","start","stop",{__opts__:["withscores"]}],zrangebylex:["id","min","max",{__opts__:["offset","count"]}],zrangebyscore:["id","min","max",{__opts__:["withscores","offset","count"]}],zrem:["id","member"],zremrangebylex:["id","min","max"],zremrangebyscore:["id","min","max"],zrevrangebylex:["id","max","min",{__opts__:["offset","count"]}],zrevrangebyscore:["id","max","min",{__opts__:["withscores","offset","count"]}],zrevrank:["id","member"]};r.decr=r.get=r.dump=r.hgetall=r.hkeys=r.hlen=r.hstrlen=r.hvals=r.incr=r.llen=r.lpop=r.persist=r.pttl=r.rpop=r.scard=r.smembers=r.strlen=r.ttl=r.type=r.zcard=["id"],r.getset=r.lpushx=e,r.del=r.exists=r.mget=r.pfcount=r.sdiff=r.sinter=r.sunion=r.watch=[t],r.incrby=r.incrbyfloat=r.decrby,r.brpop=r.blpop,r.hget=r.hexists,r.hmget=r.hdel,r.hsetnx=r.hset,r.msetnx=r.mset,r.rpush=r.lpush,r.hincrbyfloat=r.hincrby,r.srandmember=r.spop,r.zrevrange=r.zrange,r.zscore=r.zrevrank,Object.keys(r).forEach(function(e){n.prototype[e]=function(){var t,n=Array.prototype.slice.call(arguments),i=null,o={controller:"ms",action:e},s={};return"function"==typeof n[n.length-1]&&(t=n.pop()),n.length&&"object"==typeof n[n.length-1]&&1===Object.keys(n[n.length-1]).length&&void 0!==n[n.length-1].queuable&&(i=n.pop()),r[e].forEach(function(e,t){void 0!==n[t]&&(Array.isArray(e)&&(e=Array.isArray(n[t])?e[1]:e[0]),"id"===e?s._id=n[t]:(s.body||(s.body={}),"object"==typeof e&&void 0!==e.__opts__?e.__opts__.forEach(function(e){void 0!==n[t][e]&&(s.body[e]=n[t][e])}):s.body[e]=n[t]))}),this.kuzzle.query(o,s,i,t),this}})}(),e.exports=n},function(e,t,n){function r(e,t){return Object.defineProperties(this,{callback:{value:null,writable:!0},channel:{value:null,writable:!0},id:{value:u.v4()},lastRenewal:{value:null,writable:!0},notifier:{value:null,writable:!0},onDoneCB:{value:null,writable:!0},queue:{value:[],writable:!0},renewalDelay:{value:500},scope:{value:t&&t.scope?t.scope:"all"},state:{value:t&&t.state?t.state:"done"},subscribing:{value:!1,writable:!0},users:{value:t&&t.users?t.users:"none"},collection:{value:e,enumerable:!0},kuzzle:{value:e.kuzzle,enumerable:!0},filters:{value:null,enumerable:!0,writable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0},metadata:{value:t&&t.metadata?t.metadata:{},enumerable:!0,writable:!0},roomId:{value:null,enumerable:!0,writable:!0},subscribeToSelf:{value:t&&"boolean"==typeof t.subscribeToSelf?t.subscribeToSelf:!0,enumerable:!0,writable:!0}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["count"];return r&&-1!==i.indexOf(e)}}):this}function i(e){return e.error?this.callback(e.error):"jwtTokenExpired"===e.action?(this.kuzzle.jwtToken=void 0,this.kuzzle.emitEvent("jwtTokenExpired")):void(this.kuzzle.requestHistory[e.requestId]?(this.subscribeToSelf&&this.callback(null,e),delete this.kuzzle.requestHistory[e.requestId]):this.callback(null,e))}function o(){for(var e;this.queue.length>0;)e=this.queue.shift(),this[e.action].apply(this,e.args)}function s(){return"connected"===this.kuzzle.state&&!this.subscribing}var u=n(4);r.prototype.count=function(e){var t;if(this.kuzzle.callbackRequired("KuzzleRoom.count",e),t=this.kuzzle.addHeaders({body:{roomId:this.roomId}},this.headers),!s.call(this))return void this.queue.push({action:"count",args:[e]});if(!this.roomId)throw new Error("KuzzleRoom.count: cannot count subscriptions on an inactive room");this.kuzzle.query(this.collection.buildQueryArgs("subscribe","count"),t,function(t,n){e(t,n&&n.result.count)})},r.prototype.renew=function(e,t,n){var r=Date.now(),s={scope:this.scope,state:this.state,users:this.users},u=this;return"function"==typeof e&&(n=t,t=e,e=null),n||(n=u.onDoneCB),u.kuzzle.callbackRequired("KuzzleRoom.renew",t),u.lastRenewal&&r-u.lastRenewal<=u.renewalDelay?n&&n(new Error("Subscription already renewed less than "+u.renewalDelay+"ms ago")):(e&&(u.filters=e),"connected"!==u.kuzzle.state?(u.callback=t,u.onDoneCB=n,void(u.kuzzle.subscriptions.pending[u.id]=u)):u.subscribing?void u.queue.push({action:"renew",args:[e,t,n]}):(u.unsubscribe(),u.roomId=null,u.subscribing=!0,u.callback=t,u.onDoneCB=n,u.kuzzle.subscriptions.pending[u.id]=u,s.body=u.filters,s=u.kuzzle.addHeaders(s,this.headers),void u.kuzzle.query(u.collection.buildQueryArgs("subscribe","on"),s,{metadata:u.metadata},function(e,t){return delete u.kuzzle.subscriptions.pending[u.id],u.subscribing=!1,e?(u.queue=[],n&&n(new Error("Error during Kuzzle subscription: "+e.message))):(u.lastRenewal=r,u.roomId=t.result.roomId,u.channel=t.result.channel,u.kuzzle.subscriptions[u.roomId]||(u.kuzzle.subscriptions[u.roomId]={}),u.kuzzle.subscriptions[u.roomId][u.id]=u,u.notifier=i.bind(u),u.kuzzle.network.on(u.channel,u.notifier),o.call(u),void(n&&n(null,u)))})))},r.prototype.unsubscribe=function(){var e,t=this,n=t.roomId;return s.call(this)?(n&&(t.kuzzle.network.off(t.channel,this.notifier),1===Object.keys(t.kuzzle.subscriptions[n]).length?(delete t.kuzzle.subscriptions[n],0===Object.keys(t.kuzzle.subscriptions.pending).length?t.kuzzle.query(t.collection.buildQueryArgs("subscribe","off"),{body:{roomId:n}}):e=setInterval(function(){0===Object.keys(t.kuzzle.subscriptions.pending).length&&(t.kuzzle.subscriptions[n]||t.kuzzle.query(t.collection.buildQueryArgs("subscribe","off"),{body:{roomId:n}}),clearInterval(e))},100)):delete t.kuzzle.subscriptions[n][t.id],t.roomId=null),t):(t.queue.push({action:"unsubscribe",args:[]}),t)},r.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=r},function(e,t){function n(){this.cbs=[],this.error=null,this.room=null}n.prototype.onDone=function(e){return this.error||this.room?e(this.error,this.room):this.cbs.push(e),this},n.prototype.done=function(e,t){this.error=e,this.room=t,this.cbs.forEach(function(n){n(e,t)})},e.exports=n},function(e,t,n){function r(e,t,r,i){if("undefined"!=typeof window){if("undefined"!=typeof WebSocket)return new(n(2))(e,t,i);if(window.io)return new(n(12))(e,r,i);throw new Error("Aborting: no websocket support detected and no socket.io library loaded either.")}return new(n(2))(e,t,i)}e.exports=r},function(e,t){function n(e,t,n){this.host=e,this.port=t,this.ssl=n,this.socket=null,this.connect=function(e,t){this.socket=window.io((this.ssl?"https://":"http://")+this.host+":"+this.port,{reconnection:e,reconnectionDelay:t,forceNew:!0})},this.onConnect=function(e){this.socket.on("connect",e)},this.onConnectError=function(e){this.socket.on("connect_error",e)},this.onDisconnect=function(e){this.socket.on("disconnect",e)},this.onReconnect=function(e){this.socket.on("reconnect",e)},this.once=function(e,t){this.socket.once(e,t)},this.on=function(e,t){this.socket.on(e,t)},this.off=function(e,t){this.socket.off(e,t)},this.send=function(e){this.socket.emit("kuzzle",e)},this.close=function(){this.socket.close(),this.socket=null}}e.exports=n},function(e,t,n){function r(e,t,n){return i.call(this,e,t,n),Object.defineProperties(this,{deleteActionName:{value:"deleteProfile"},updateActionName:{value:"updateProfile"}}),e.kuzzle.bluebird?e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["hydrate","save"];return r&&-1!==i.indexOf(e)}}):void 0}var i=n(1);r.prototype=Object.create(i.prototype,{constructor:{value:r}}),r.prototype.save=function(e,t){var n,r=this;if(!this.content.policies)throw new Error('Argument "policies" is mandatory in a profile. This argument contains an array of objects.');return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),n=this.serialize(),r.kuzzle.query(r.kuzzleSecurity.buildQueryArgs("createOrReplaceProfile"),n,e,t&&function(e){t(e,e?void 0:r)}),r},r.prototype.addPolicy=function(e){if("object"!=typeof e||"string"!=typeof e.roleId)throw new Error('Parameter "policies" must be an object containing at least a "roleId" member which must be a string.');return this.content.policies||(this.content.policies=[]),this.content.policies.push(e),this},r.prototype.setPolicies=function(e){if(!Array.isArray(e))throw new Error('Parameter "policies" must be an array of objects containing at least a "roleId" member which must be a string');return e.map(function(e){if("object"!=typeof e||"string"!=typeof e.roleId)throw new Error('Parameter "policies" must be an array of objects containing at least a "roleId" member which must be a string')}),this.content.policies=e,this},r.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e},r.prototype.getPolicies=function(){return this.content.policies},e.exports=r},function(e,t,n){function r(e,t,n){return i.call(this,e,t,n),Object.defineProperties(this,{deleteActionName:{value:"deleteRole"},updateActionName:{value:"updateRole"}}),e.kuzzle.bluebird?e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["save"];return r&&-1!==i.indexOf(e)}}):void 0}var i=n(1);r.prototype=Object.create(i.prototype,{constructor:{value:r}}),r.prototype.save=function(e,t){var n=this.serialize(),r=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),r.kuzzle.query(this.kuzzleSecurity.buildQueryArgs("createOrReplaceRole"),n,e,t&&function(e){t(e,e?void 0:r)}),this},e.exports=r},function(e,t,n){function r(e){return Object.defineProperty(this,"kuzzle",{value:e}),Object.defineProperty(this,"buildQueryArgs",{value:function(e){return{controller:"security",action:e}}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,n,r){var i=["roleFactory","profileFactory","userFactory","isActionAllowed"];return r&&-1===i.indexOf(e)}}):this}var i=n(14),o=n(13),s=n(3);r.prototype.getRole=function(e,t,n){var r,o=this;if(!e)throw new Error("Id parameter is mandatory for getRole function");n||"function"!=typeof t||(n=t,t=null),r={_id:e},o.kuzzle.callbackRequired("KuzzleSecurity.getRole",n),o.kuzzle.query(this.buildQueryArgs("getRole"),r,t,function(e,t){n(e,e?void 0:new i(o,t.result._id,t.result._source))})},r.prototype.searchRoles=function(e,t,n){var r=this;n||"function"!=typeof t||(n=t,t=null),r.kuzzle.callbackRequired("KuzzleSecurity.searchRoles",n),r.kuzzle.query(this.buildQueryArgs("searchRoles"),{body:e},t,function(e,t){var o;return e?n(e):(o=t.result.hits.map(function(e){return new i(r,e._id,e._source)}),void n(null,{total:t.result.total,roles:o}))})},r.prototype.createRole=function(e,t,n,r){var o=this,s={},u="createRole";if(!e||"string"!=typeof e)throw new Error("KuzzleSecurity.createRole: cannot create a role without a role ID");r||"function"!=typeof n||(r=n,n=null),s._id=e,s.body=t,n&&(u=n.replaceIfExist?"createOrReplaceRole":"createRole"),o.kuzzle.query(this.buildQueryArgs(u),s,n,r&&function(e,t){r(e,e?void 0:new i(o,t.result._id,t.result._source))})},r.prototype.updateRole=function(e,t,n,r){var o=this,s={_id:e,body:t},u="updateRole";if(!e||"string"!=typeof e)throw new Error("KuzzleSecurity.updateRole: cannot update a role without a role ID");return r||"function"!=typeof n||(r=n,n=null),o.kuzzle.query(this.buildQueryArgs(u),s,n,r&&function(n){r(n,n?void 0:new i(o,e,t))}),this},r.prototype.deleteRole=function(e,t,n){var r={_id:e};return n||"function"!=typeof t||(n=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteRole"),r,t,n&&function(e,t){n(e,e?void 0:t.result._id)}),this},r.prototype.roleFactory=function(e,t){return new i(this,e,t)},r.prototype.getProfile=function(e,t,n){var r,i=this;if(n||"function"!=typeof t||(n=t,t=null),!e||"string"!=typeof e)throw new Error("Id parameter is mandatory for getProfile function");r={_id:e},i.kuzzle.callbackRequired("KuzzleSecurity.getProfile",n),i.kuzzle.query(this.buildQueryArgs("getProfile"),r,t,function(e,t){n(e,e?void 0:new o(i,t.result._id,t.result._source))})},r.prototype.searchProfiles=function(e,t,n){var r=this;n||"function"!=typeof t||(n=t,t=null),r.kuzzle.callbackRequired("KuzzleSecurity.searchProfiles",n),r.kuzzle.query(this.buildQueryArgs("searchProfiles"),{body:e},t,function(e,t){var i;return e?n(e):(i=t.result.hits.map(function(e){return new o(r,e._id,e._source)}),void n(null,{total:t.result.total,profiles:i}))})},r.prototype.createProfile=function(e,t,n,r){var i=this,s={},u="createProfile";if(!e||"string"!=typeof e)throw new Error("KuzzleSecurity.createProfile: cannot create a profile without a profile ID");r||"function"!=typeof n||(r=n,n=null),s._id=e,s.body=t,n&&(u=n.replaceIfExist?"createOrReplaceProfile":"createProfile"),i.kuzzle.query(this.buildQueryArgs(u),s,n,r&&function(e,t){r(e,e?void 0:new o(i,t.result._id,t.result._source))})},r.prototype.updateProfile=function(e,t,n,r){var i=this,s={},u="updateProfile";if(!e||"string"!=typeof e)throw new Error("KuzzleSecurity.updateProfile: cannot update a profile without a profile ID");return r||"function"!=typeof n||(r=n,n=null),s._id=e,s.body=t,i.kuzzle.query(this.buildQueryArgs(u),s,n,r&&function(e,t){var n={};return e?r(e):(Object.keys(t.result._source).forEach(function(e){n[e]=t.result._source[e]}),void r(null,new o(i,t.result._id,n)))}),this},r.prototype.deleteProfile=function(e,t,n){var r={_id:e};return n||"function"!=typeof t||(n=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteProfile"),r,t,n&&function(e,t){n(e,e?void 0:t.result._id)}),this},r.prototype.profileFactory=function(e,t){return new o(this,e,t)},r.prototype.getUser=function(e,t,n){var r={_id:e},i=this;if(!e||"string"!=typeof e)throw new Error("Id parameter is mandatory for getUser function");n||"function"!=typeof t||(n=t,t=null),i.kuzzle.callbackRequired("KuzzleSecurity.getUser",n),i.kuzzle.query(this.buildQueryArgs("getUser"),r,t,function(e,t){n(e,e?void 0:new s(i,t.result._id,t.result._source))})},r.prototype.searchUsers=function(e,t,n){var r=this;n||"function"!=typeof t||(n=t,t=null),r.kuzzle.callbackRequired("KuzzleSecurity.searchUsers",n),r.kuzzle.query(this.buildQueryArgs("searchUsers"),{body:e},t,function(e,t){var i;return e?n(e):(i=t.result.hits.map(function(e){return new s(r,e._id,e._source)}),void n(null,{total:t.result.total,users:i}))})},r.prototype.createUser=function(e,t,n,r){var i=this,o={_id:e,body:t},u="createUser";if(!e||"string"!=typeof e)throw new Error("KuzzleSecurity.createUser: cannot create a user without a user ID");r||"function"!=typeof n||(r=n,n=null),n&&(u=n.replaceIfExist?"createOrReplaceUser":"createUser"),i.kuzzle.query(this.buildQueryArgs(u),o,null,r&&function(e,t){r(e,e?void 0:new s(i,t.result._id,t.result._source))})},r.prototype.updateUser=function(e,t,n,r){var i=this,o={},u="updateUser";if(!e||"string"!=typeof e)throw new Error("KuzzleSecurity.updateUser: cannot update an user without an user ID");return r||"function"!=typeof n||(r=n,n=null),o._id=e,o.body=t,i.kuzzle.query(this.buildQueryArgs(u),o,n,r&&function(e,t){r(e,e?void 0:new s(i,t.result._id,t.result._source))}),this},r.prototype.deleteUser=function(e,t,n){var r={_id:e};return n||"function"!=typeof t||(n=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteUser"),r,t,n&&function(e,t){n(e,e?void 0:t.result._id)}),this},r.prototype.userFactory=function(e,t){return new s(this,e,t)},r.prototype.isActionAllowed=function(e,t,n,r,i){var o;if(!e||"object"!=typeof e)throw new Error("rights parameter is mandatory for isActionAllowed function");if(!t||"string"!=typeof t)throw new Error("controller parameter is mandatory for isActionAllowed function");if(!n||"string"!=typeof n)throw new Error("action parameter is mandatory for isActionAllowed function");return o=e.filter(function(e){return e.controller===t||"*"===e.controller}).filter(function(e){return e.action===n||"*"===e.action}).filter(function(e){return e.index===r||"*"===e.index}).filter(function(e){return e.collection===i||"*"===e.collection}),o.some(function(e){return"allowed"===e.value})?"allowed":o.some(function(e){return"conditional"===e.value})?"conditional":"denied"},r.prototype.getUserRights=function(e,t,n){var r={_id:e},i=this;if(!e||"string"!=typeof e)throw new Error("userId parameter is mandatory for getUserRights function");n||"function"!=typeof t||(n=t,t=null),i.kuzzle.callbackRequired("Kuzzle.getUserRights",n),this.kuzzle.query(this.buildQueryArgs("getUserRights"),r,t,n&&function(e,t){n(e,e?void 0:t.result.hits)})},e.exports=r}])});
//# sourceMappingURL=kuzzle.min.js.map
